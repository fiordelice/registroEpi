<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de EPI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label { font-weight: bold; }
    select, input {
      margin: 5px 0;
      padding: 5px;
      width: 250px;
    }
    button {
      padding: 8px 15px;
      margin-top: 10px;
      cursor: pointer;
    }
    ul { list-style: none; padding: 0; }
    li {
      background: #f2f2f2;
      margin-bottom: 5px;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>Controle de EPI</h1>

  <label for="cs">CS:</label><br>
  <input type="text" id="cs" placeholder="Digite o CS"><br>

  <label for="tipoEpi">Tipo de EPI:</label><br>
  <select id="tipoEpi" onchange="atualizarModelos()">
    <option value="">Selecione</option>
  </select><br>

  <label for="modeloEpi">Modelo:</label><br>
  <select id="modeloEpi" onchange="atualizarTamanhos()">
    <option value="">Selecione</option>
  </select><br>

  <label for="tamanhoEpi">Tamanho:</label><br>
  <select id="tamanhoEpi" onchange="mostrarCodigo()">
    <option value="">Selecione</option>
  </select><br>

  <p><strong>C√≥digo:</strong> <span id="codigoEpi"></span></p>

  <label for="motivo">Motivo:</label><br>
  <input type="text" id="motivo" placeholder="Ex: Troca, Novo, etc"><br>

  <button onclick="registrarEntrega()">Registrar</button>

  <h2>Registros</h2>
  <ul id="listaRegistros"></ul>

  <script type="module">
    // üî• Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ‚öôÔ∏è Configura√ß√£o do Firebase (substitua pelos seus dados)
    const firebaseConfig = {
      apiKey: "SUA_API_KEY_AQUI",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "XXXXXXXXXXXX",
      appId: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
    };

    // üîß Inicializa√ß√£o
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    // üì¶ Dados dos EPIs
    const epiData = {
      capacete: {
        "Suspens√£o Carneira com Jugular": { M: "6057580", G: "6014089" }
      },
      oculos: {
        "√ìculos Incolor": { √önico: "6016960" },
        "√ìculos Cinza": { √önico: "6016961" },
        "√ìculos Ampla Vis√£o": { √önico: "6008482" }
      },
      botina: {
        "Bota PVC sem Bico de A√ßo": {
          35: "6002760", 36: "6002732", 37: "6002733", 38: "6002734",
          39: "6002735", 40: "6002736", 41: "6002737", 42: "6002738",
          43: "6002739", 44: "6002740", 45: "6018105"
        },
        "Bota Vaqueta com Composite": {
          36: "6050775", 37: "6050761", 38: "6050760", 39: "6050734",
          40: "6050768", 41: "6050744", 42: "6050759", 43: "6050733",
          44: "6050743", 45: "6050732", 46: "6050767", 47: "6049174"
        },
        "Botina de Amarrar Antitor√ß√£o": {
          34: "6054631", 35: "6054630", 36: "6054664", 37: "6054622",
          38: "6054663", 39: "6054672", 40: "6054621", 41: "6054683",
          42: "6054682", 43: "6054681", 44: "6054662", 45: "6054661",
          46: "6054680", 47: "6054671"
        }
      },
      colete: {
        "Colete Verde Lim√£o": { M: "6027671", G: "6027672", GG: "6039623", XGG: "6057591" }
      },
      protetorAuricular: {
        "Plug Silicone 3 Tamanhos": { P: "6016022", M: "6044293", G: "6057569" }
      },
      luvas: {
        "Luva Resist√™ncia Mec√¢nica": { 8: "6043567", 9: "6043568", 10: "6047676", 11: "6052203" }
      },
      uniforme: {
        "Camisa Manga Curta": { PP: "6040852", P: "6040886", M: "6040925", G: "6040926", GG: "6040927", XG: "6040928" },
        "Camisa Manga Longa": { PP: "6038450", P: "6040931", M: "6040932", G: "6040933", GG: "6040866" },
        "Cal√ßa Cinza": { PP: "6040870", P: "6040872", M: "6040873", G: "6040895", GG: "6040897" }
      }
    };

    // üß† Popula tipos
    const tipoEpi = document.getElementById("tipoEpi");
    Object.keys(epiData).forEach(tipo => {
      const opt = document.createElement("option");
      opt.value = tipo;
      opt.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);
      tipoEpi.appendChild(opt);
    });

    // üîÅ Atualiza modelos
    window.atualizarModelos = function() {
      const tipo = tipoEpi.value;
      const modeloSelect = document.getElementById("modeloEpi");
      modeloSelect.innerHTML = "<option value=''>Selecione</option>";
      document.getElementById("tamanhoEpi").innerHTML = "<option value=''>Selecione</option>";
      document.getElementById("codigoEpi").textContent = "";

      if (tipo && epiData[tipo]) {
        Object.keys(epiData[tipo]).forEach(modelo => {
          const opt = document.createElement("option");
          opt.value = modelo;
          opt.textContent = modelo;
          modeloSelect.appendChild(opt);
        });
      }
    };

    // üîÅ Atualiza tamanhos
    window.atualizarTamanhos = function() {
      const tipo = tipoEpi.value;
      const modelo = document.getElementById("modeloEpi").value;
      const tamanhoSelect = document.getElementById("tamanhoEpi");
      tamanhoSelect.innerHTML = "<option value=''>Selecione</option>";
      document.getElementById("codigoEpi").textContent = "";

      if (tipo && modelo && epiData[tipo][modelo]) {
        Object.keys(epiData[tipo][modelo]).forEach(tam => {
          const opt = document.createElement("option");
          opt.value = tam;
          opt.textContent = tam;
          tamanhoSelect.appendChild(opt);
        });
      }
    };

    // üßæ Mostra c√≥digo
    window.mostrarCodigo = function() {
      const tipo = tipoEpi.value;
      const modelo = document.getElementById("modeloEpi").value;
      const tamanho = document.getElementById("tamanhoEpi").value;
      const codigo = epiData[tipo]?.[modelo]?.[tamanho] || "";
      document.getElementById("codigoEpi").textContent = codigo;
    };

    // üíæ Registrar entrega
    window.registrarEntrega = async function() {
      const cs = document.getElementById("cs").value.trim();
      const tipo = tipoEpi.value;
      const modelo = document.getElementById("modeloEpi").value;
      const tamanho = document.getElementById("tamanhoEpi").value;
      const codigo = document.getElementById("codigoEpi").textContent;
      const motivo = document.getElementById("motivo").value.trim();

      if (!cs || !tipo || !modelo || !tamanho || !codigo || !motivo) {
        alert("‚ö†Ô∏è Preencha todos os campos!");
        return;
      }

      const novoRegistro = { cs, tipo, modelo, tamanho, codigo, motivo, data: new Date().toISOString() };

      // Local
      const registros = JSON.parse(localStorage.getItem("registrosEPI")) || [];
      registros.push(novoRegistro);
      localStorage.setItem("registrosEPI", JSON.stringify(registros));

      // Firestore
      try {
        await addDoc(collection(db, "registrosEPI"), novoRegistro);
        console.log("‚úÖ Salvo no Firestore");
      } catch (err) {
        console.error("‚ùå Erro ao salvar na nuvem:", err);
      }

      atualizarListaRegistros();
      alert("‚úÖ Registro salvo com sucesso!");
    };

    // üìã Atualiza lista
    window.atualizarListaRegistros = function() {
      const lista = document.getElementById("listaRegistros");
      lista.innerHTML = "";
      const registros = JSON.parse(localStorage.getItem("registrosEPI")) || [];

      registros.forEach(r => {
        const li = document.createElement("li");
        li.textContent = `[${new Date(r.data).toLocaleString()}] CS: ${r.cs} - ${r.tipo} - ${r.modelo} (${r.tamanho}) - ${r.motivo}`;
        lista.appendChild(li);
      });
    };

    // ‚òÅÔ∏è Carrega registros da nuvem
    async function carregarRegistrosNuvem() {
      const querySnapshot = await getDocs(collection(db, "registrosEPI"));
      const registros = [];
      querySnapshot.forEach(doc => registros.push(doc.data()));
      localStorage.setItem("registrosEPI", JSON.stringify(registros));
      atualizarListaRegistros();
    }

    carregarRegistrosNuvem();
  </script>
</body>
</html>
